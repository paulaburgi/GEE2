/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var g07in3 = /* color: #d63000 */ee.Geometry.Polygon(
        [[[-123.31458091752211, 43.78599776772117],
          [-123.31453800217787, 43.784262759120395],
          [-123.31419467942396, 43.784014896638105],
          [-123.31329345719496, 43.78339523593623],
          [-123.31329345719496, 43.782217862907196],
          [-123.31552505509535, 43.781877040071265],
          [-123.31651210801283, 43.781040466690996],
          [-123.31762790696303, 43.78125735720991],
          [-123.31848621384779, 43.781660151800416],
          [-123.31852912919203, 43.78274458528645],
          [-123.31814289109388, 43.78286851928951],
          [-123.31809997574965, 43.78351916859043],
          [-123.31874370591322, 43.78373605011708],
          [-123.31900119797865, 43.78478946348302],
          [-123.31968784348646, 43.78494437564769],
          [-123.32050323502699, 43.78457258577806],
          [-123.32050323502699, 43.78351916859043],
          [-123.32161903397719, 43.78342621912387],
          [-123.32170486466566, 43.78293048619468],
          [-123.32110404984633, 43.78289950275014],
          [-123.32076072709242, 43.78190802404572],
          [-123.31977367417494, 43.78184605608075],
          [-123.31977367417494, 43.781040466690996],
          [-123.31930160538832, 43.78063766792555],
          [-123.31874370591322, 43.779894032305926],
          [-123.3179283143727, 43.77942925534684],
          [-123.31552505509535, 43.779491225816805],
          [-123.31363677994887, 43.77952221102768],
          [-123.31363677994887, 43.77986304728772],
          [-123.31363677994887, 43.78125735720991],
          [-123.31256389634291, 43.78125735720991],
          [-123.31213474290053, 43.78125735720991],
          [-123.31153392808119, 43.781474246942004],
          [-123.31119060532728, 43.78196999194648],
          [-123.31131935136, 43.782434749154774],
          [-123.31161975876967, 43.78268261818858],
          [-123.3116626741139, 43.78327130302509],
          [-123.31179142014662, 43.783581134821205],
          [-123.31179142014662, 43.78407686235502],
          [-123.3118772508351, 43.78494437564769],
          [-123.31174850480238, 43.785687948450004],
          [-123.31157684342543, 43.7861836585131],
          [-123.312220573589, 43.786214640255544],
          [-123.31234931962172, 43.78698917859815],
          [-123.31200599686781, 43.78702015992307],
          [-123.31200599686781, 43.78723702874816],
          [-123.3124351503102, 43.787453896786374],
          [-123.31234931962172, 43.78841430292627],
          [-123.31234931962172, 43.78909587211551],
          [-123.3142375947682, 43.7893746936347],
          [-123.31578254716078, 43.78860018620319],
          [-123.3156967164723, 43.78711310380161],
          [-123.31526756302992, 43.78708212252483],
          [-123.31526756302992, 43.7864624936171]]]),
    g07out3 = /* color: #1bd643 */ee.Geometry.MultiPolygon(
        [[[[-123.31350803375244, 43.77961516656402],
           [-123.31050395965576, 43.77977009213676],
           [-123.30968856811523, 43.7796771368413],
           [-123.30904483795166, 43.78014191187347],
           [-123.30835819244385, 43.78011092698376],
           [-123.30780029296875, 43.78073062172766],
           [-123.30728530883789, 43.78196999194648],
           [-123.30754280090332, 43.78320933647316],
           [-123.30814361572266, 43.78379801612304],
           [-123.30822944641113, 43.78630758538656],
           [-123.3081865310669, 43.78748487787047],
           [-123.30810070037842, 43.78856920475173],
           [-123.30883026123047, 43.78962253294771],
           [-123.3090877532959, 43.79005625092711],
           [-123.30968856811523, 43.79045898623271],
           [-123.30977439880371, 43.78990135201007],
           [-123.30994606018066, 43.789188811820985],
           [-123.31067562103271, 43.78884802872776],
           [-123.31153392791748, 43.7887241071212],
           [-123.31174850463867, 43.789188811820985],
           [-123.31209182739258, 43.78912685140309],
           [-123.31239223480225, 43.78782566779018],
           [-123.3120059967041, 43.78748487692501],
           [-123.31183433532715, 43.78714408411685],
           [-123.31230640411377, 43.78683427078701],
           [-123.31144809739271, 43.7861836585131],
           [-123.31179142014662, 43.78528518099688],
           [-123.31157684342543, 43.783581134821205],
           [-123.31149101273695, 43.782775568811296],
           [-123.3111047746388, 43.782310814252504],
           [-123.31106185929457, 43.78175310401282],
           [-123.3118772508351, 43.781319325785084],
           [-123.31269264237562, 43.781195388570524],
           [-123.31346511857191, 43.78113341986688]]],
         [[[-123.31599712371826, 43.781939008004144],
           [-123.31552505493164, 43.78246573284021],
           [-123.31535339355469, 43.7829614696232],
           [-123.31561088562012, 43.78392194794227],
           [-123.3160400390625, 43.784045879504575],
           [-123.31625461578369, 43.784913393246875],
           [-123.3165979385376, 43.78537812757308],
           [-123.31685543060303, 43.78578089439994],
           [-123.31865787506104, 43.78584285828629],
           [-123.3186149597168, 43.78454160318456],
           [-123.31797122955322, 43.78441767264995],
           [-123.31762790679932, 43.78361211791251],
           [-123.31741333007812, 43.78317835317312],
           [-123.3169412612915, 43.78293048619468],
           [-123.31689834594727, 43.78234179800215],
           [-123.31668376922607, 43.781660151800416]]],
         [[[-123.32088947296143, 43.78100948132135],
           [-123.32093238830566, 43.78200097492721],
           [-123.32140445709229, 43.78252769921733],
           [-123.32239151000977, 43.782496715564044],
           [-123.32363605499268, 43.78252769921733],
           [-123.32492351531982, 43.78175310306728],
           [-123.32518100738525, 43.781288340559954],
           [-123.32346439361572, 43.7796771358957],
           [-123.32213401794434, 43.77977009119117],
           [-123.32183361053467, 43.78004895621049],
           [-123.32149028778076, 43.779832061307864],
           [-123.32054615020752, 43.77961516561843],
           [-123.3191728591919, 43.78007994113235],
           [-123.31968784332275, 43.780916527952805],
           [-123.31981658935547, 43.78178408710598],
           [-123.32067489624023, 43.7818150711286]]]]),
    g07out3ss = /* color: #ffc82d */ee.Geometry.MultiPolygon(
        [[[[-123.3163833618164, 43.7884143019808],
           [-123.31629753112793, 43.78801155289767],
           [-123.31565380096436, 43.78813547598151],
           [-123.31526756286621, 43.78847626313737],
           [-123.31518173217773, 43.78884802872776],
           [-123.31479549407959, 43.78884802872776],
           [-123.31475257873535, 43.78928175232737],
           [-123.31432342529297, 43.7894676329066],
           [-123.31432342529297, 43.78990135201007],
           [-123.31359386444092, 43.78990135201007],
           [-123.31359386444092, 43.790273108736585],
           [-123.31406593322754, 43.790366047556894],
           [-123.31389427185059, 43.790582904242314],
           [-123.31307888031006, 43.79064486315076],
           [-123.31299304962158, 43.79095465672958],
           [-123.31264972686768, 43.79123346957756],
           [-123.31398010253906, 43.790799760140914],
           [-123.31453800201416, 43.79014919008466],
           [-123.31475257873535, 43.78971547277967],
           [-123.31531047821045, 43.78959155297161],
           [-123.31586837768555, 43.789033910655824]]],
         [[[-123.32015991210938, 43.78482044500255],
           [-123.32024574279785, 43.785625983457585],
           [-123.32084655761719, 43.78522321558694],
           [-123.32213401794434, 43.78416980986443],
           [-123.32286357879639, 43.783271302079555],
           [-123.32294940948486, 43.78265163367],
           [-123.3220911026001, 43.782403764507755],
           [-123.32161903381348, 43.782806551374556],
           [-123.32174777984619, 43.78339523499069],
           [-123.32046031951904, 43.783612116966964],
           [-123.32054615020752, 43.78454160223904]]],
         [[[-123.32273483276367, 43.77877856153436],
           [-123.31955909729004, 43.777012356919016],
           [-123.31779956817627, 43.77667150440882],
           [-123.31376552581787, 43.77679545100098],
           [-123.31350803375244, 43.776547557559745],
           [-123.311448097229, 43.77735320748628],
           [-123.3102035522461, 43.77871659032577],
           [-123.30840110778809, 43.779460240589856],
           [-123.30883026123047, 43.77998698726419],
           [-123.30960273742676, 43.77970812195584],
           [-123.31350803375244, 43.779491225816805],
           [-123.31792831420898, 43.77939827008775],
           [-123.3184003829956, 43.77980107720313],
           [-123.3211898803711, 43.779832062253455],
           [-123.32324981689453, 43.7796771368413]]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
var int_all = ee.ImageCollection("users/pmb229/cascadia/all_good_int1"); 

// get a test int as image
var fidx = ee.Filter.eq('idx', 0); 
var ici  = int_all.filter(fidx); 
var int = ee.Image(ici.first());
var vizparams2    = {min: -3.14, max: 3.14, palette: ['9400D3', '4B0082', '0000FF', '00FF00', 'FFFF00', 'FF7F00', 'FF0000']}; 


// // in/out of clear cut geometry - sumatra
// var g08 = ee.Geometry.MultiPoint(
//         [[100.44913530349731, 0.5128958865177399],
//         [100.44681787490845, 0.5141189247068775]]);
// var g07out = ee.Geometry.MultiPoint(
//         [[100.69772931594849, 0.6102875700520651]]);
// var g07in  = ee.Geometry.MultiPoint(
//         [[100.69759368896484, 0.6128271035674982]]);

//in/out of clear cut geometry - cascadia
  // var g07in   = ee.Geometry.MultiPoint(
  //         [[-123.40543270111084, 43.822731120282704]]); 
  // var g07out  = ee.Geometry.MultiPoint(
  //         [[-123.40396063232422, 43.82555365818388]]);
  // var g07inr  = ee.Geometry.Rectangle([-123.4064, 43.8218, -123.4043, 43.8236]); //lonmin, latmin, lonmax, latmax
  // var g07outr = ee.Geometry.Rectangle([-123.4051, 43.8248, -123.4028, 43.8265]); 
// area 2
  var g07inr  = ee.Geometry.Rectangle([-123.37522, 43.82465, -123.3696, 43.827]); //lonmin, latmin, lonmax, latmax
  var g07outr = ee.Geometry.Rectangle([-123.36539, 43.82871, -123.35986, 43.83109]); 
  var g07outrp = ee.Geometry.Rectangle([-123.37522, 43.82871, -123.3696, 43.83109]); 
// area 3
  // in the imports above

var gin  = g07inr//.buffer(100); 
var gout = g07outr//.buffer(100); 
var regionin  = gin
var regionout = gout
Map.addLayer(int, vizparams2, 'int '); 
Map.addLayer(gin, {}, 'rectangle in '); 
Map.addLayer(g07outrp, {}, 'rectangle out'); 
  Map.centerObject(regionin, 15)
  

// get circular mean, and circular difference
var imf = function(image) {
  // perform circular mean
  var s = image.sin()
  var c = image.cos()
  var sum_cos_in = ee.Array(c.reduceRegion({
  reducer: ee.Reducer.sum(), 
  geometry: gin,
  scale: 1}).get('b1'))
  var sum_sin_in = ee.Array(s.reduceRegion({
  reducer: ee.Reducer.sum(),
  geometry: gin,
  scale: 1}).get('b1'))
  var sum_cos_out = ee.Array(c.reduceRegion({
  reducer: ee.Reducer.sum(), 
  geometry: gout,
  scale: 1}).get('b1'))
  var sum_sin_out = ee.Array(s.reduceRegion({
  reducer: ee.Reducer.sum(),
  geometry: gout,
  scale: 1}).get('b1'))
    var m_in  = sum_cos_in.atan2(sum_sin_in)
    var m_out = sum_cos_out.atan2(sum_sin_out)
    var phs1   = ee.Array(m_in)
    var phs2   = ee.Array(m_out)  
    var den   = phs2.cos().pow(2).add(phs2.sin().pow(2))
    var rl1   = phs2.cos().multiply(phs1.cos()).add(phs1.sin().multiply(phs2.sin()))
    var rl    = rl1.divide(den)
    var im1   = phs1.cos().multiply(phs2.sin()).multiply(-1).add(phs1.sin().multiply(phs2.cos()))
    var im    = im1.divide(den)
    var pd    = rl.atan2(im)
  var phsdif  = ee.Number(pd)
  var image = image
  .set('meanphs_in', m_in)
  .set('meanphs_out', m_out)
  .set('meanphsdiff', phsdif)
  return image
  }
var int_all_mean = int_all.map(imf)


// get  mean and  difference (linear)
var imf2 = function(image) {
  var m_in = image.reduceRegion({
  reducer: ee.Reducer.mean(),
  geometry: gin,
  scale: 30})
  var m_out = image.reduceRegion({
  reducer: ee.Reducer.mean(),
  geometry: gout,
  scale: 30})
  // calc phs difference 
    var num1   = ee.Number(m_in.get('b1'))
    var num2   = ee.Number(m_out.get('b1'))    
    var phs1   = ee.Array(m_in.get('b1'))
    var phs2   = ee.Array(m_out.get('b1'))  
    var phsdif = num1.subtract(num2)
    var phsdif = phsdif.abs()
  var image = image
  .set('meanphs_in', m_in.get('b1'))
  .set('meanphs_out', m_out.get('b1'))
  .set('meanphsdiff', phsdif)
  return image
  }
var int_all_mean2 = int_all.map(imf2)



// plot! 
var baselines = ee.List(int_all_mean.aggregate_array("baseline"));
var phsdiff   = ee.List(int_all_mean.aggregate_array("meanphsdiff"));

var baselines2 = ee.List(int_all_mean2.aggregate_array("baseline"));
var phsdiff2   = ee.List(int_all_mean2.aggregate_array("meanphsdiff"));

var chart = ui.Chart.array.values(phsdiff, 0, baselines)
    .setOptions({
      //title: 'baseline vs phase difference (circular)',
      //hAxis: ,
      vAxis: {'title': 'phase diff'},
      pointSize: 4,
      hAxis: {title: 'Baseline', viewWindow: {min: 0, max: 1800}},
      vAxis: {title: 'Phs Diff', viewWindow: {min:-3.14, max:3.14},
      ticks: [{v: -3.14, f: '3.14'},
                {v: 0, f: '0'},
                {v: 3.14, f: '3.14'}]}
});

// var chart2 = ui.Chart.array.values(phsdiff2, 0, baselines2)
//     .setOptions({
//       title: 'baseline vs phase difference (linear)',
//       hAxis: {'title': 'baseline'},
//       vAxis: {'title': 'phase diff'},
//       pointSize: 3,
// });

print('int', int)
print(chart)
//print(chart2)




